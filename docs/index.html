<html lang="en">
<head>
    <title>fntags framework example</title>
</head>
<body>
<script type="module">
    import { fntags, fnbind } from './fntags.js'

    fntags.hoist()
    const foo = ( aFoo ) =>
        div( { style: 'background: darkcyan' },
             'One of my foos: ',
             aFoo.foo
        )

    let appState = fntags.initState( {
                                         currentUser: {
                                             name: 'fntags'
                                         },
                                         myFoos: [ { foo: 'Hannibal' }, { foo: 'Face(man)' }, { foo: 'Howling Mad' }, { foo: 'B.A.' } ]
                                     } )


    const myForm = ( { message, fontSize, stateColor, inputStateColor } ) => {
        let inputState = fntags.initState( { color: inputStateColor } )
        return form( { style: `font-size: ${fontSize}` },
                     'State Data: ',
                     fnbind( appState,
                             input( {
                                        value: appState.currentUser.name,
                                        oninput: ( e ) => {
                                            appState.currentUser = Object.assign( appState.currentUser,
                                                                                  { name: e.target.value } )
                                        }
                                    } ),
                             ( el, st ) => el.value = st.currentUser.name
                     ),
                     br(), br(),
                     'InputState Color: ',
                     fnbind( inputState,
                             input( {
                                        value: inputState.color,
                                        oninput: ( e ) => {
                                            inputState.color = e.target.value
                                        }
                                    } ),
                             ( el, st ) => el.value = st.color
                     ),
                     p(
                         fnbind( appState,
                                 () =>
                                     div(
                                         h4( message ),
                                         span( { style: `color: ${stateColor}` },
                                               `appState.currentUser.name: ${appState.currentUser.name}`
                                         ),
                                         br(),
                                         fnbind( inputState,
                                                 () =>
                                                     span( { style: `color: ${inputState.color}` },
                                                           `inputState.color: ${inputState.color}`
                                                     )
                                         )
                                     ) ),
                         br(),
                         input( { value: 'unbound input' } )
                     )
        )
    }

    const greeting = () => {
        //state that's private to this component
        const greetingState = fntags.initState( { greeting: 'Hello' } )

        //create a variable to store our created div so that it doesn't get re-created on every update
        let greetingDiv
        const buildGreetingDiv = () => div(
            //bind to any number of states by passing an array
            fnbind( [ appState, greetingState ],
                    () => `${greetingState.greeting} ${appState.currentUser.name}!`
            ),
            br(), br(),

            //bind to our private state
            fnbind( greetingState,
                    input( {
                               value: greetingState.greeting,

                               //setting this property will update all bound elements
                               oninput: ( e ) => {greetingState.greeting = e.target.value}
                           } ),

                    //the update function that defines what happens when the state gets updated.
                    ( el, st ) => el.value = st.greeting
            ),

            //bind to our app state
            fnbind( appState,
                    input( {
                               value: appState.currentUser.name,
                               oninput: ( e ) => {

                                   //updates are only triggered by direct properties of the state
                                   //therefore you need to actually re-assign currentUser to trigger an update
                                   appState.currentUser = Object.assign( appState.currentUser, {
                                       name: e.target.value
                                   } )
                               }
                           } ),
                    ( el, st ) => {el.value = st.currentUser.name}
            )
        )

        if( appState.loaded ) greetingDiv = buildGreetingDiv()

        return fnbind( appState,
                       () => greetingDiv || 'Welcome!',
                       ( el, st ) => {
                           if( st.loaded ) {
                               if( !greetingDiv ) greetingDiv = buildGreetingDiv()
                               return greetingDiv
                           } else return 'Welcome!'
                       }
        )
    }


    document.body.append(
        div( { id: 'App' },
             greeting(),
             myForm( {
                         message: 'First form',
                         fontSize: '20px',
                         stateColor: 'blue',
                         inputStateColor: 'lime'
                     } ),
             p( 'This is an example of some static text',
                div(
                    div(
                        div( { style: 'color: limegreen' },
                             div(
                                 fnbind( appState, () => `nested divs with bound state ${appState.currentUser.name}` )
                             )
                        )
                    )
                ),
                pre( code( { class: 'lang-js' }, 'console.log("code tags!")' ) )
             ),
             myForm( {
                         message: 'Second form',
                         fontSize: '24px',
                         stateColor: 'pink',
                         inputStateColor: 'purple'
                     } ),
             br(), br(),
             button( { onclick: () => appState.myFoos = appState.myFoos.concat( { foo: 'foo' } ) },
                     'More foos'
             ),
             button( { onclick: () => appState.myFoos = appState.myFoos.slice( 0, -1 ) },
                     'Less foos'
             ),
             fnbind( appState, () => div( ...appState.myFoos.map( foo ) ) )
        )
    )
    setTimeout( ( ( ast ) => () => {
                    console.log( 'hello' )
                    ast.loaded = true
                } )( appState ),
                2000 )
</script>
</body>
</html>